// Created by: Clinical CDS System
// Purpose: Diabetes diagnosis and management rules based on Rwanda National Guidelines 2022
// Source: Rwanda Standard Treatment Guidelines, Section III: Diabetes Mellitus
// Reference doc: Rwanda Diabetes Guidelines (2022). See uploaded file. :contentReference[oaicite:1]{index=1}

package com.rwanda.health.cds.rules

import com.rwanda.health.cds.models.PatientData
import com.rwanda.health.cds.models.ClinicalDecision
import com.rwanda.health.cds.models.Investigations
import com.rwanda.health.cds.models.MedicalHistory
import com.rwanda.health.cds.models.PhysicalExamination
import com.rwanda.health.cds.models.PatientDemographics

// =============================================
// DIABETES DIAGNOSIS AND CLASSIFICATION RULES
// (unchanged logic; phrasing left intact)
// =============================================

// Rule 1: Diabetes Diagnosis by HbA1c (Highest Priority)
rule "Diabetes Diagnosis by HbA1c"
    salience 100
    when
        $patient: PatientData(
            investigations.hba1c >= 6.5
        )
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Diabetes Mellitus");
        decision.setStage("Confirmed by HbA1c");
        decision.setPatientAdvice("Diabetes confirmed. Requires comprehensive management including lifestyle modifications and pharmacological treatment.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Diabetes Diagnosis by HbA1c");
end

// Rule 2: Diabetes Diagnosis by Fasting Glucose
rule "Diabetes Diagnosis by Fasting Glucose"
    salience 95
    when
        $patient: PatientData(
            investigations.fastingGlucose >= 7.0
        )
        not ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Diabetes Mellitus");
        decision.setStage("Confirmed by Fasting Glucose");
        decision.setPatientAdvice("Diabetes confirmed by fasting glucose. Requires immediate lifestyle intervention and medication.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Diabetes Diagnosis by Fasting Glucose");
end

// Rule 3: Diabetes Diagnosis by Random Glucose with Symptoms
rule "Diabetes Diagnosis by Random Glucose with Symptoms"
    salience 90
    when
        $patient: PatientData(
            investigations.randomGlucose >= 11.1,
            medicalHistory.diabetesSymptoms == true
        )
        not ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Diabetes Mellitus");
        decision.setStage("Confirmed by Random Glucose with Symptoms");
        decision.setPatientAdvice("Diabetes confirmed. Symptoms include polyuria, polydipsia, weight loss, blurred vision.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Diabetes Diagnosis by Random Glucose with Symptoms");
end

// Rule 4: Prediabetes Identification
rule "Prediabetes Identification"
    salience 85
    when
        $patient: PatientData(
            (investigations.hba1c >= 5.7 && investigations.hba1c < 6.5) ||
            (investigations.fastingGlucose >= 5.6 && investigations.fastingGlucose < 7.0)
        )
        not ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Prediabetes");
        decision.setStage("High Risk");
        decision.setPatientAdvice("High risk for diabetes. Intensive lifestyle modifications recommended to prevent progression to diabetes.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Prediabetes Identification");
end

// Rule 5: Type 1 Diabetes Classification
rule "Type 1 Diabetes Classification"
    salience 80
    when
        $patient: PatientData(
            demographics.age < 30,
            medicalHistory.diabetesOnset == "acute",
            (medicalHistory.ketoacidosisHistory == true || medicalHistory.autoimmuneDisease == true)
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.setSubClassification("Type 1 Diabetes");
        $decision.setPatientAdvice($decision.getPatientAdvice() + " Type 1 diabetes suspected - requires insulin therapy. Refer to endocrinology.");
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Suspected Type 1 Diabetes - requires insulin initiation");
        System.out.println("Applied rule: Type 1 Diabetes Classification");
end

// Rule 6: Type 2 Diabetes Classification
rule "Type 2 Diabetes Classification"
    salience 75
    when
        $patient: PatientData(
            demographics.age >= 30,
            medicalHistory.obesity == true || medicalHistory.familyHistoryDiabetes == true
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
        not ClinicalDecision(subClassification == "Type 1 Diabetes") from $patient.getDecisions()
    then
        $decision.setSubClassification("Type 2 Diabetes");
        System.out.println("Applied rule: Type 2 Diabetes Classification");
end

// =============================================
// GLYCEMIC CONTROL ASSESSMENT AND TREATMENT
// Clarified OR vs AND and explicit dual therapy rules
// =============================================

// NEW RULE: At diagnosis - Consider Dual Therapy if HbA1c >= 9% (explicit per guideline)
rule "At Diagnosis - Start Dual Therapy if HbA1c >= 9%"
    salience 92
    when
        $patient: PatientData(
            investigations.hba1c >= 9.0
        )
        not ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        // If diabetes not yet captured by other diagnosis rules, create a decision indicating dual therapy need at diagnosis.
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Diabetes Mellitus");
        decision.setStage("At diagnosis - Indication for Dual Therapy");
        // Explicit instruction: start Metformin AND add a second agent (AND). Options for second agent are separated by OR.
        decision.setPatientAdvice("At diagnosis with HbA1c ≥9%: initiate DUAL THERAPY now. Start METFORMIN AND add ONE of: Sulfonylurea (Gliclazide) OR DPP4 inhibitor OR SGLT2 inhibitor. Reassess HbA1c in 3 months.");
        decision.addMedication("Metformin (start) 500mg daily for 5 days then 500mg twice daily (titrate as tolerated)");
        decision.addMedication("AND add ONE of: Sulfonylurea (Gliclazide) 30-120mg OD/BD  OR  Glimepiride 1-8mg OD  OR  DPP4 inhibitor (Vildagliptin/Sitagliptin)  OR  SGLT2 inhibitor (Dapagliflozin)");
        decision.addTest("HbA1c in 3 months");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: At Diagnosis - Start Dual Therapy if HbA1c >= 9%");
end

// Rule 7: Poor Glycemic Control - Needs Dual Therapy (HbA1c >=9%)  -- clarified AND/OR
rule "Poor Glycemic Control HbA1c >=9%"
    salience 70
    when
        $patient: PatientData(
            investigations.hba1c >= 9.0
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 2 Diabetes") from $patient.getDecisions()
    then
        $decision.setStage("Poor Control - Needs Dual Therapy");
        // Explicit: Metformin AND add another agent. Partner choices are alternatives (OR).
        $decision.addMedication("Metformin (continue/start) 500mg daily x5 days then 500mg BD (titrate)");
        $decision.addMedication("AND add ONE of (choose ONE): Sulfonylurea (Gliclazide - preferred) OR Glimepiride OR Glibenclamide (if indicated) OR DPP4 inhibitor OR SGLT2 inhibitor");
        // Provide clearer separate items for UI readability
        $decision.addMedication("Combination semantics: (METFORMIN) AND (SULFONYLUREA OR DPP4i OR SGLT2i)  -- dual therapy (both agents given together).");

        String currentAdvice = $decision.getPatientAdvice();
        String advice = "POOR GLYCEMIC CONTROL (HbA1c ≥9%): Initiate DUAL THERAPY = Metformin AND a second agent. Choose partner based on patient profile: Sulfonylurea (first choice) OR DPP4i OR SGLT2i.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + advice);
        } else {
            $decision.setPatientAdvice(advice);
        }

        System.out.println("Applied rule: Poor Glycemic Control HbA1c >=9%");
end

// Rule 8: Very Poor Control - Consider Insulin (>=10%) - clarify combinations AND/OR
rule "Very Poor Glycemic Control HbA1c >=10%"
    salience 65
    when
        $patient: PatientData(
            investigations.hba1c >= 10.0 || investigations.randomGlucose >= 16.7
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 2 Diabetes") from $patient.getDecisions()
    then
        $decision.setStage("Very Poor Control - Consider Insulin");
        // Explicit: consider insulin; if using oral agents, insulin is added (AND) or replace oral agents when necessary.
        $decision.addMedication("Consider initiating INSULIN therapy (basal or basal-bolus) in addition to continuing Metformin when appropriate (Metformin AND Insulin), or consider insulin replacement if severe.");
        $decision.addMedication("If remaining on oral therapy: Metformin AND Sulfonylurea AND/OR add insulin per clinical indication (note: insulin addition is often required).");
        $decision.addMedication("Total daily insulin dose guidance: ~0.5 U/kg (individualize).");

        String currentAdvice = $decision.getPatientAdvice();
        String advice = "VERY POOR CONTROL (HbA1c ≥10% or marked symptoms): Consider insulin initiation. Use Metformin AND insulin where appropriate, or insulin-based regimen if severe. Refer if initiation/education needed.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + advice);
        } else {
            $decision.setPatientAdvice(advice);
        }

        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Very poor glycemic control - consider insulin and specialist input");

        System.out.println("Applied rule: Very Poor Glycemic Control HbA1c >=10%");
end

// Rule 9: Moderate Control - Monotherapy (HbA1c <9% at diagnosis) - explicit MONOTHERAPY
rule "Moderate Glycemic Control HbA1c <9%"
    salience 60
    when
        $patient: PatientData(
            investigations.hba1c < 9.0 && investigations.hba1c >= 6.5
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 2 Diabetes") from $patient.getDecisions()
    then
        $decision.setStage("New Diagnosis - Start Monotherapy");
        // MONOTHERAPY: choose Metformin (first-line). The "OR" in monotherapy selection is not commonly used here because Metformin is first-line.
        $decision.addMedication("Initiate METFORMIN 500mg once daily for 5 days; titrate to 500mg twice daily if tolerated. (MONOTHERAPY)");
        $decision.addMedication("Maximum usual oral metformin dose: up to 1000mg twice daily if tolerated");

        String currentAdvice = $decision.getPatientAdvice();
        String advice = "HbA1c <9% at diagnosis: start METFORMIN MONOTHERAPY. Reassess HbA1c in 3 months and consider DUAL THERAPY if not at target.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + advice);
        } else {
            $decision.setPatientAdvice(advice);
        }

        System.out.println("Applied rule: Moderate Glycemic Control HbA1c <9%");
end

// Rule 10: Treatment Failure - Add second agent or escalate (after 3 months on max tolerated metformin)
rule "Treatment Failure After 3 Months"
    salience 55
    when
        $patient: PatientData(
            medicalHistory.currentMedications contains "Metformin",
            investigations.hba1c >= 7.0,
            medicalHistory.treatmentDuration >= 3
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 2 Diabetes") from $patient.getDecisions()
    then
        $decision.setStage("Treatment Failure - Needs Intensification");
        // Clarify: add a second agent (AND). Multiple alternative second agents are given as OR.
        $decision.addMedication("Add a SECOND agent (DUAL THERAPY): Metformin AND one of (Sulfonylurea (Gliclazide) OR DPP4 inhibitor OR SGLT2 inhibitor).");
        $decision.addMedication("If already on dual therapy and still uncontrolled, consider TRIPLE THERAPY: Metformin AND Sulfonylurea AND (DPP4i OR SGLT2i) OR consider injectable therapy (insulin).");

        String currentAdvice = $decision.getPatientAdvice();
        String advice = "Treatment failure after 3 months on metformin: Add SECOND agent (Metformin AND partner). If still uncontrolled on dual therapy, consider TRIPLE THERAPY (Metformin AND two others) or insulin.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + advice);
        } else {
            $decision.setPatientAdvice(advice);
        }

        System.out.println("Applied rule: Treatment Failure After 3 Months");
end

// =============================================
// FIRST-LINE TREATMENT AND CONTRAINDICATIONS
// (clarify OR usage in contraindications and alternatives)
// =============================================

// Rule 11: Metformin First Line Therapy
rule "First Line Therapy - Metformin"
    when
        $patient: PatientData(
            medicalHistory.renalImpairment == false,
            investigations.egfr >= 45,
            medicalHistory.liverDisease == false
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 2 Diabetes") from $patient.getDecisions()
    then
        $decision.addMedication("Metformin 500mg once daily with meals (MONOTHERAPY/FOUNDATION agent)");
        $decision.addMedication("Titrate to 500mg twice daily after 1-2 weeks (as tolerated)");
        $decision.addMedication("Maximum dose 1000mg twice daily if tolerated");

        $decision.addTest("Renal function tests baseline");
        $decision.addTest("Liver function tests");
        $decision.addTest("Fasting lipid profile");

        String currentAdvice = $decision.getPatientAdvice();
        String advice = "Metformin is first-line therapy unless contraindicated. If contraindicated, choose alternative monotherapy/therapy (see contraindication rule).";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + advice);
        } else {
            $decision.setPatientAdvice(advice);
        }

        System.out.println("Applied rule: First Line Therapy - Metformin");
end

// Rule 12: Metformin Contraindications - Renal Impairment
rule "Metformin Contraindication Renal"
    salience 50
    when
        $patient: PatientData(
            medicalHistory.renalImpairment == true ||
            investigations.egfr < 45
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        // Clarify alternatives (OR) when Metformin contraindicated
        $decision.addMedication("METFORMIN CONTRAINDICATED due to renal impairment (eGFR <45).");
        $decision.addMedication("Start Sulfonylurea as first-line alternative (Gliclazide 30mg OD) OR consider Insulin if hyperglycemia is severe.");
        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Metformin contraindicated due to renal impairment. Use Sulfonylurea OR Insulin depending on severity.");
        System.out.println("Applied rule: Metformin Contraindication Renal");
end

// Rule 13: Type 1 Diabetes Insulin Requirement (unchanged but clarified choices)
rule "Type 1 Diabetes Insulin Therapy"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus", subClassification == "Type 1 Diabetes") from $patient.getDecisions()
    then
        $decision.addMedication("INSULIN THERAPY REQUIRED for Type 1 Diabetes (basal-bolus preferred OR twice-daily mixed if unavailable)");
        $decision.addMedication("Total daily dose: 0.5-1.0 IU/kg/day (adjust per age/stage)");
        $decision.addMedication("Regimen: Basal-bolus preferred OR Twice-daily mixed insulin (if basal-bolus not feasible)");

        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Type 1 Diabetes - requires insulin initiation and education");

        System.out.println("Applied rule: Type 1 Diabetes Insulin Therapy");
end

// =============================================
// COMORBIDITY-BASED TREATMENT RECOMMENDATIONS
// (clarified OR where used)
// =============================================

// Rule 14: Diabetes with Hypertension
rule "Diabetes with Hypertension Comorbidity"
    when
        $patient: PatientData(
            physicalExamination != null,
            (physicalExamination.systole >= 130 ||
            physicalExamination.diastole >= 80)
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        // Use ACEI OR ARB (choose one) — explicit OR
        $decision.addMedication("ACEI (Captopril) OR ARB (Losartan) preferred for hypertension in diabetes (choose ONE).");
        $decision.addMedication("Target BP: <130/80 mmHg");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Hypertension present. Tight BP control needed (target <130/80). Use ACEI OR ARB unless contraindicated.");
        System.out.println("Applied rule: Diabetes with Hypertension Comorbidity");
end

// Rule 15: Diabetes with Cardiovascular Disease
rule "Diabetes with CVD Comorbidity"
    when
        $patient: PatientData(
            medicalHistory.cardiovascularDisease == true ||
            medicalHistory.cad == true
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("Consider SGLT2 inhibitors if available (cardioprotective) - OR other cardioprotective agent as per availability");
        $decision.addMedication("Statin therapy for all patients with diabetes and CVD");
        $decision.addMedication("Aspirin 75-100mg daily if not contraindicated");

        $decision.addTest("ECG - baseline");
        $decision.addTest("Cardiac risk assessment annually");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Cardiovascular disease present. Requires aggressive risk factor management and cardioprotective medications.");
        System.out.println("Applied rule: Diabetes with CVD Comorbidity");
end

// Rule 16: Diabetes with Chronic Kidney Disease
rule "Diabetes with CKD Comorbidity"
    when
        $patient: PatientData(
            medicalHistory.chronicKidneyDisease == true ||
            investigations.egfr < 60
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("SGLT2 inhibitors preferred if eGFR ≥30 (OR when indicated)");
        $decision.addMedication("ACEI/ARB for renal protection (choose ONE unless contraindicated)");
        $decision.addMedication("Avoid metformin if eGFR <45");

        $decision.addTest("Urine Albumin-Creatinine Ratio quarterly");
        $decision.addTest("Serum potassium monitoring");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Chronic kidney disease present. Renal-protective strategies and medication dose adjustments needed.");
        System.out.println("Applied rule: Diabetes with CKD Comorbidity");
end

// =============================================
// COMPLICATION SCREENING AND MANAGEMENT (unchanged content; phrasing clarified)
// =============================================

// Rule 17: Retinopathy Screening
rule "Retinopathy Screening"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addTest("Annual dilated eye examination for retinopathy");
        $decision.addTest("Retinal photography if available");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Annual eye examinations crucial to detect diabetic retinopathy early.");

        System.out.println("Applied rule: Retinopathy Screening");
end

// Rule 18: Neuropathy Screening
rule "Neuropathy Screening"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addTest("Annual foot examination for sensation");
        $decision.addTest("Monofilament testing");
        $decision.addTest("Ask about numbness, tingling, burning pain in feet");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Regular foot examinations essential. Report any foot problems immediately.");

        System.out.println("Applied rule: Neuropathy Screening");
end

// Rule 19: Neuropathy Symptoms Management
rule "Neuropathy Symptoms Management"
    when
        $patient: PatientData(
            medicalHistory.neuropathySymptoms == true
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("Amitriptyline 25mg at night for neuropathic pain");
        $decision.addMedication("OR Gabapentin if available and amitriptyline not effective");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Neuropathy symptoms present. Requires symptomatic treatment and regular foot care.");

        System.out.println("Applied rule: Neuropathy Symptoms Management");
end

// Rule 20: Nephropathy Management
rule "Nephropathy Management"
    when
        $patient: PatientData(
            medicalHistory.persistentProteinuria == true
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("Start ACEI (or ARB) and refer to Internist/Nephrologist");
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Persistent proteinuria - requires nephrology evaluation");

        System.out.println("Applied rule: Nephropathy Management");
end

// =============================================
// STATIN AND ASPIRIN THERAPY (unchanged)
// =============================================

// Rule 21: Statin Therapy Indication
rule "Statin Therapy for Diabetes"
    when
        $patient: PatientData(
            demographics.age >= 40 && demographics.age <= 75
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("Statin therapy recommended for all diabetic patients 40-75 years");

        String currentAdvice = $decision.getPatientAdvice();
        $decision.setPatientAdvice((currentAdvice != null ? currentAdvice + " " : "") + "Statin therapy recommended for cardiovascular risk reduction.");

        System.out.println("Applied rule: Statin Therapy for Diabetes");
end

// Rule 22: Aspirin Therapy Consideration
rule "Aspirin Therapy Consideration"
    when
        $patient: PatientData(
            medicalHistory.cardiovascularRiskFactors == true
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addMedication("Consider Aspirin 75-162 mg/day for primary prevention in increased CV risk");

        System.out.println("Applied rule: Aspirin Therapy Consideration");
end

// =============================================
// EMERGENCY SITUATIONS - DKA / HHS (unchanged logic)
// =============================================

// Rule 23: DKA Suspicion
rule "DKA Suspicion"
    when
        $patient: PatientData(
            (investigations.bloodGlucose > 13.9 || investigations.ketonuria == true) &&
            (medicalHistory.abdominalPain == true || medicalHistory.nauseaVomiting == true ||
             medicalHistory.dehydration == true || medicalHistory.rapidBreathing == true)
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Suspected Diabetic Ketoacidosis - EMERGENCY");

        $decision.setPatientAdvice("DIABETIC EMERGENCY: Possible ketoacidosis. Immediate medical attention required. Go to emergency department. IV fluids and insulin needed.");

        System.out.println("Applied rule: DKA Suspicion");
end

// Rule 24: Hyperglycemic Emergency - Transfer Indication
rule "Hyperglycemic Emergency Transfer"
    when
        $patient: PatientData(
            investigations.bloodGlucose > 22.2 || // >400 mg/dl
            (investigations.bloodGlucose >= 11.1 && investigations.bloodGlucose <= 22.2 &&
             medicalHistory.dangerSigns == true)
        )
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Severe hyperglycemia with danger signs - Transfer to District Hospital");

        $decision.setPatientAdvice("EMERGENCY: Severe hyperglycemia with danger signs (dehydration, abdominal pain, hypotension, confusion). Immediate transfer to hospital required.");

        System.out.println("Applied rule: Hyperglycemic Emergency Transfer");
end

// =============================================
// LIFESTYLE AND PATIENT EDUCATION (unchanged content)
// =============================================

// Rule 25: Diabetes Lifestyle Recommendations
rule "Diabetes Lifestyle Modifications"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String lifestyleAdvice = "Lifestyle: Low-fat, low-carbohydrate diet. Avoid sugar, sweets, juice. Physical activity 30min/day, 5 days/week. Smoking cessation. Diabetes education.";

        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + lifestyleAdvice);
        } else {
            $decision.setPatientAdvice(lifestyleAdvice);
        }

        System.out.println("Applied rule: Diabetes Lifestyle Modifications");
end

// Rule 26: Diet Education Details
rule "Diet Education Details"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String dietAdvice = "Diet: 50% vegetables, small portion of one carbohydrate variety per meal, portion of protein, small oil, 1-2 fruits. Avoid sugar, sweets, juice.";

        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + dietAdvice);
        } else {
            $decision.setPatientAdvice(dietAdvice);
        }

        System.out.println("Applied rule: Diet Education Details");
end

// Rule 27: Follow-up Testing Recommendations
rule "Diabetes Follow-up Testing"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        $decision.addTest("HbA1c every 3-6 months");
        $decision.addTest("Urine protein every 3-6 months");
        $decision.addTest("Serum creatinine annually");
        $decision.addTest("Fasting lipid profile annually");
        $decision.addTest("Liver function tests annually");

        System.out.println("Applied rule: Diabetes Follow-up Testing");
end

// =============================================
// HYPOGLYCEMIA MANAGEMENT (unchanged)
// =============================================

// Rule 28: Hypoglycemia Management Education
rule "Hypoglycemia Management Education"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String hypoAdvice = "Hypoglycemia management: For BG <70mg/dl, take 15g fast-acting carbs (3 tsp sugar, 150ml juice). Repeat after 15 minutes if still low. Always carry sugar source.";

        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + hypoAdvice);
        } else {
            $decision.setPatientAdvice(hypoAdvice);
        }

        System.out.println("Applied rule: Hypoglycemia Management Education");
end

// Rule 29: Risk Factor Identification (unchanged)
rule "Diabetes Risk Factors Identification"
    when
        $patient: PatientData(
            demographics.age > 40 ||
            medicalHistory.overweight == true ||
            medicalHistory.familyHistoryDiabetes == true ||
            medicalHistory.historyGDM == true ||
            medicalHistory.hivPositive == true
        )
        not ClinicalDecision(diagnosis == "Diabetes Mellitus") from $patient.getDecisions()
        not ClinicalDecision(diagnosis == "Prediabetes") from $patient.getDecisions()
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("High Risk for Diabetes");
        decision.setStage("Risk Factors Present");
        decision.setPatientAdvice("High risk for diabetes due to age >40, overweight, family history, history GDM, or HIV. Consider annual screening.");
        decision.setConfidenceLevel("MODERATE");
        decision.addTest("Annual diabetes screening recommended");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Diabetes Risk Factors Identification");
end
