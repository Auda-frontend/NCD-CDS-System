// Created by: Clinical CDS System
// Purpose: Hypertension diagnosis and treatment rules based on Rwanda National Guidelines 2023
// Source: Rwanda Standard Treatment Guidelines, Section II: Cardiology

package com.rwanda.health.cds.rules

import com.rwanda.health.cds.models.PatientData
import com.rwanda.health.cds.models.ClinicalDecision
import com.rwanda.health.cds.models.PhysicalExamination
import com.rwanda.health.cds.models.MedicalHistory
import com.rwanda.health.cds.models.PatientDemographics

// =============================================
// HYPERTENSION CLASSIFICATION RULES (PRIORITY-BASED)
// =============================================

// Rule 1: Grade 3 Hypertension (Highest Priority - Most Severe)
rule "Grade 3 Hypertension Classification"
    salience 100
    when
        $patient: PatientData(
            physicalExamination.systole >= 180 || 
            physicalExamination.diastole >= 110
        )
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Severe Hypertension");
        decision.setStage("Grade 3");
        decision.setPatientAdvice("EMERGENCY: Hypertensive urgency/emergency. Immediate medical attention required.");
        decision.setNeedsReferral(true);
        decision.setReferralReason("Grade 3 Hypertension - potential hypertensive emergency");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 3 Hypertension Classification");
end

// Rule 2: Grade 2 Hypertension (High Priority)
rule "Grade 2 Hypertension Classification"
    salience 90
    when
        $patient: PatientData(
            (physicalExamination.systole >= 160 && physicalExamination.systole < 180) || 
            (physicalExamination.diastole >= 100 && physicalExamination.diastole < 110)
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if Grade 3 exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Hypertension");
        decision.setStage("Grade 2");
        decision.setPatientAdvice("Urgent pharmacological treatment required. Dual therapy recommended if BP >20/10 mmHg above goal.");
        decision.setNeedsReferral(true);
        decision.setReferralReason("Grade 2 Hypertension requiring combination therapy");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 2 Hypertension Classification");
end

// Rule 3: Grade 1 Hypertension (Medium Priority)
rule "Grade 1 Hypertension Classification"
    salience 80
    when
        $patient: PatientData(
            (physicalExamination.systole >= 140 && physicalExamination.systole <= 159) || 
            (physicalExamination.diastole >= 90 && physicalExamination.diastole <= 99)
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Hypertension");
        decision.setStage("Grade 1");
        decision.setPatientAdvice("Initiate lifestyle modifications and consider pharmacological treatment based on risk factors.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 1 Hypertension Classification");
end

// Rule 4: Isolated Systolic Hypertension (Medium Priority)
rule "Isolated Systolic Hypertension Classification"
    salience 75
    when
        $patient: PatientData(
            physicalExamination.systole >= 140 && 
            physicalExamination.diastole < 90
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Isolated Systolic Hypertension");
        decision.setStage("Based on systolic reading");
        decision.setPatientAdvice("Common in elderly patients. Requires pharmacological treatment and lifestyle modifications.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Isolated Systolic Hypertension Classification");
end

// Rule 5: Isolated Diastolic Hypertension (Medium Priority)
rule "Isolated Diastolic Hypertension Classification"
    salience 75
    when
        $patient: PatientData(
            physicalExamination.systole < 140 && 
            physicalExamination.diastole >= 90
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Isolated Diastolic Hypertension");
        decision.setStage("Based on diastolic reading");
        decision.setPatientAdvice("More common in younger patients. Requires pharmacological treatment and lifestyle modifications.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Isolated Diastolic Hypertension Classification");
end

// Rule 6: High Normal BP (Low Priority)
rule "High Normal Blood Pressure Classification"
    salience 60
    when
        $patient: PatientData(
            (physicalExamination.systole >= 130 && physicalExamination.systole <= 139) || 
            (physicalExamination.diastole >= 85 && physicalExamination.diastole <= 89)
        )
        not ClinicalDecision()  // Don't fire if any hypertension diagnosis exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("High Normal Blood Pressure");
        decision.setStage("Pre-Hypertension");
        decision.setPatientAdvice("Lifestyle modifications recommended: smoking cessation, physical activity 150 min/week, DASH diet. Monitor BP regularly.");
        decision.addTest("Annual BP monitoring");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: High Normal Blood Pressure Classification");
end

// Rule 7: Normal Blood Pressure (Lowest Priority)
rule "Normal Blood Pressure Classification"
    salience 50
    when
        $patient: PatientData(
            physicalExamination.systole < 130 && 
            physicalExamination.diastole < 85
        )
        not ClinicalDecision()  // Don't fire if any diagnosis exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Normal Blood Pressure");
        decision.setStage("Normal");
        decision.setPatientAdvice("Maintain healthy lifestyle with regular exercise and balanced diet. Follow DASH diet recommendations.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Normal Blood Pressure Classification");
end

// =============================================
// INITIAL TREATMENT RECOMMENDATIONS (Figure 9)
// =============================================

// Rule 8: Grade 1 Hypertension - Monotherapy
rule "Grade 1 Hypertension Initial Therapy"
    when
        $patient: PatientData(
            physicalExamination.systole >= 140 && physicalExamination.systole <= 159 || 
            physicalExamination.diastole >= 90 && physicalExamination.diastole <= 99
        )
        $decision: ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1") from $patient.getDecisions()
    then
        // First-line monotherapy options
        $decision.addMedication("Amiodipine 5mg once daily (Preferred CCB)");
        $decision.addMedication("Hydrochlorothiazide 12.5mg once daily");
        $decision.addMedication("Lisinopril 2.5mg once daily (if no contraindications)");
        $decision.addMedication("Losartan 25mg once daily (if ACEI not tolerated)");
        
        $decision.addTest("ECG");
        $decision.addTest("Urine Albumin-Creatinine ratio");
        $decision.addTest("Serum electrolytes and creatinine");
        $decision.addTest("Lipid profile");
        $decision.addTest("Fasting blood glucose/HbA1c");
        
        System.out.println("Applied rule: Grade 1 Hypertension Initial Therapy");
end

// Rule 9: Grade 2 Hypertension - Dual Therapy
rule "Grade 2 Hypertension Dual Therapy"
    when
        $patient: PatientData(
            physicalExamination.systole >= 160 || 
            physicalExamination.diastole >= 100
        )
        $decision: ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2") from $patient.getDecisions()
    then
        // Dual combination therapy as per guidelines
        $decision.addMedication("ACEI/ARB + CCB combination");
        $decision.addMedication("OR ACEI/ARB + Diuretic combination");
        $decision.addMedication("Single Pill Combination preferred when available");
        
        $decision.addTest("ECG - urgent");
        $decision.addTest("Echocardiogram if available");
        $decision.addTest("Complete renal function tests");
        $decision.addTest("Fundoscopy if indicated");
        
        System.out.println("Applied rule: Grade 2 Hypertension Dual Therapy");
end

// Rule 10: Grade 3 Hypertension - Emergency Treatment
rule "Grade 3 Hypertension Emergency Therapy"
    when
        $patient: PatientData(
            physicalExamination.systole >= 180 || 
            physicalExamination.diastole >= 110
        )
        $decision: ClinicalDecision(diagnosis == "Severe Hypertension") from $patient.getDecisions()
    then
        // Emergency treatment options
        $decision.addMedication("Labetalol IV - first line emergency");
        $decision.addMedication("Nicardipine IV - alternative");
        $decision.addMedication("Nitroprusside IV - for specific emergencies");
        
        $decision.addTest("ECG - immediate");
        $decision.addTest("Cardiac enzymes - STAT");
        $decision.addTest("Renal function tests - STAT");
        $decision.addTest("Fundoscopy - urgent");
        $decision.addTest("CXR if pulmonary edema suspected");
        
        System.out.println("Applied rule: Grade 3 Hypertension Emergency Therapy");
end

// =============================================
// COMORBIDITY-BASED TREATMENT RECOMMENDATIONS
// =============================================

// Rule 11: Hypertension with Diabetes
rule "Hypertension with Diabetes Comorbidity"
    when
        $patient: PatientData(medicalHistory.diabetes == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // Preferred in diabetes: CCB or Thiazide
        $decision.addMedication("CCB (Amiodipine) preferred in diabetes");
        $decision.addMedication("OR Thiazide diuretic");
        $decision.addMedication("Target BP: 130/80 mmHg or lower if tolerated");
        
        $decision.addTest("HbA1c - quarterly monitoring");
        $decision.addTest("Urine ACR - annual");
        $decision.addTest("Foot examination");
        
        String currentAdvice = $decision.getPatientAdvice();
        String diabetesAdvice = "Strict blood pressure and glucose control needed. Target BP <130/80 mmHg. Regular eye and foot examinations.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + diabetesAdvice);
        } else {
            $decision.setPatientAdvice(diabetesAdvice);
        }
        
        System.out.println("Applied rule: Hypertension with Diabetes Comorbidity");
end

// Rule 12: Hypertension with Chronic Kidney Disease
rule "Hypertension with CKD Comorbidity"
    when
        $patient: PatientData(medicalHistory.chronicKidneyDisease == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // ARB or ACEI preferred in CKD (except if K+ >5.5 or pregnant)
        $decision.addMedication("ARB or ACEI preferred (monitor potassium)");
        $decision.addMedication("Target BP: <140/90 to 130/80 if tolerated");
        
        $decision.addTest("Serum potassium regularly");
        $decision.addTest("eGFR monitoring");
        $decision.addTest("Urine ACR");
        
        String currentAdvice = $decision.getPatientAdvice();
        String ckdAdvice = "ACEI/ARB preferred for renal protection. Monitor potassium levels regularly. Fluid and salt restriction may be needed.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + ckdAdvice);
        } else {
            $decision.setPatientAdvice(ckdAdvice);
        }
        
        System.out.println("Applied rule: Hypertension with CKD Comorbidity");
end

// Rule 13: Hypertension with CAD
rule "Hypertension with CAD Comorbidity"
    when
        $patient: PatientData(medicalHistory.cad == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // Beta-blockers indicated for CAD
        $decision.addMedication("Consider beta-blockers for CAD indication");
        $decision.addMedication("Target BP: 130/80 mmHg or lower if tolerated");
        
        $decision.addTest("Cardiac enzymes if symptomatic");
        $decision.addTest("Stress ECG if indicated");
        
        String currentAdvice = $decision.getPatientAdvice();
        String cadAdvice = "Beta-blockers recommended for coronary artery disease. Regular cardiac follow-up needed.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + cadAdvice);
        } else {
            $decision.setPatientAdvice(cadAdvice);
        }
        
        System.out.println("Applied rule: Hypertension with CAD Comorbidity");
end

// =============================================
// CONTRAINDICATIONS AND SAFETY RULES
// =============================================

// Rule 14: ACEI/ARB Contraindication - Hyperkalemia
rule "ACEI ARB Contraindication Hyperkalemia"
    when
        $patient: PatientData(medicalHistory.hyperkalemia == true)
        $decision: ClinicalDecision() from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String hyperkalemiaAdvice = "ACEI/ARB contraindicated due to hyperkalemia. Consider CCB or thiazide instead.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + hyperkalemiaAdvice);
        } else {
            $decision.setPatientAdvice(hyperkalemiaAdvice);
        }
        System.out.println("Applied rule: ACEI/ARB Contraindication - Hyperkalemia");
end

// Rule 15: Pregnancy and Hypertension
rule "Hypertension in Pregnancy"
    when
        $patient: PatientData(demographics.gender == "Female", medicalHistory.pregnant == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // First-line in pregnancy: Labetalol and Methyldopa
        $decision.addMedication("Labetalol - first line");
        $decision.addMedication("Methyldopa - first line");
        $decision.addMedication("Nifedipine ER - alternative");
        $decision.addMedication("Avoid ACEI/ARB - contraindicated in pregnancy");
        
        String currentAdvice = $decision.getPatientAdvice();
        String pregnancyAdvice = "OBSTETRICAL EMERGENCY: Urgent obstetric review needed. Target BP <140/90 mmHg. Labetalol or Methyldopa recommended.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + pregnancyAdvice);
        } else {
            $decision.setPatientAdvice(pregnancyAdvice);
        }
        
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Hypertension in pregnancy - requires obstetric management");
        
        System.out.println("Applied rule: Hypertension in Pregnancy");
end

// =============================================
// HYPERTENSIVE EMERGENCY RULES
// =============================================

// Rule 16: Hypertensive Emergency Detection
rule "Hypertensive Emergency Detection"
    when
        $patient: PatientData(
            physicalExamination.systole >= 180 || 
            physicalExamination.diastole >= 120
        )
        $decision: ClinicalDecision(diagnosis == "Severe Hypertension") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String emergencyAdvice = "HYPERTENSIVE EMERGENCY: Immediate transfer to emergency department. Lower BP by 25% within first hour.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + emergencyAdvice);
        } else {
            $decision.setPatientAdvice(emergencyAdvice);
        }
        
        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Hypertensive emergency - requires hospital admission");
        
        $decision.addTest("ECG - immediate");
        $decision.addTest("Cardiac enzymes");
        $decision.addTest("Renal function tests");
        $decision.addTest("Fundoscopy");
        
        System.out.println("Applied rule: Hypertensive Emergency Detection");
end

// Rule 17: Lifestyle Recommendations for All Hypertension Patients
rule "Lifestyle Modifications All Hypertension"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String lifestyleAdvice = "Lifestyle modifications: Smoking cessation, DASH diet, 150 min/week moderate activity, weight management, salt restriction.";
        
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + lifestyleAdvice);
        } else {
            $decision.setPatientAdvice(lifestyleAdvice);
        }
        
        System.out.println("Applied rule: Lifestyle Modifications All Hypertension");
end