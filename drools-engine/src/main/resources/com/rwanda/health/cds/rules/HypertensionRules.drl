// Created by: Clinical CDS System
// Purpose: Hypertension diagnosis and treatment rules based on Rwanda National Guidelines 2023
// Source: Rwanda Standard Treatment Guidelines, Section II: Cardiology
// Reference doc: Rwanda HTN Guidelines (2023). See uploaded file. :contentReference[oaicite:1]{index=1}

package com.rwanda.health.cds.rules

import com.rwanda.health.cds.models.PatientData
import com.rwanda.health.cds.models.ClinicalDecision
import com.rwanda.health.cds.models.PhysicalExamination
import com.rwanda.health.cds.models.MedicalHistory
import com.rwanda.health.cds.models.PatientDemographics

// =============================================
// HYPERTENSION CLASSIFICATION RULES (PRIORITY-BASED)
// =============================================

// Rule 1: Grade 3 Hypertension (Highest Priority - Most Severe)
rule "Grade 3 Hypertension Classification"
    salience 100
    when
        $patient: PatientData(
            consultation.consultationType != "follow_up",  // Don't classify for follow-up visits
            physicalExamination.systole >= 180 ||
            physicalExamination.diastole >= 110
        )
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Severe Hypertension");
        decision.setStage("Grade 3");
        decision.setPatientAdvice("EMERGENCY: Hypertensive urgency/emergency. Immediate medical attention required.");
        decision.setNeedsReferral(true);
        decision.setReferralReason("Grade 3 Hypertension - potential hypertensive emergency");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 3 Hypertension Classification");
end

// Rule 2: Grade 2 Hypertension (High Priority)
rule "Grade 2 Hypertension Classification"
    salience 90
    when
        $patient: PatientData(
            consultation.consultationType != "follow_up",  // Don't classify for follow-up visits
            (physicalExamination.systole >= 160 && physicalExamination.systole < 180) ||
            (physicalExamination.diastole >= 100 && physicalExamination.diastole < 110)
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if Grade 3 exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Hypertension");
        decision.setStage("Grade 2");
        decision.setPatientAdvice("Urgent pharmacological treatment required. Dual therapy recommended if BP >20/10 mmHg above goal.");
        decision.setNeedsReferral(true);
        decision.setReferralReason("Grade 2 Hypertension requiring combination therapy");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 2 Hypertension Classification");
end

// Rule 3: Grade 1 Hypertension (Medium Priority)
rule "Grade 1 Hypertension Classification"
    salience 80
    when
        $patient: PatientData(
            consultation.consultationType != "follow_up",  // Don't classify for follow-up visits
            (physicalExamination.systole >= 140 && physicalExamination.systole <= 159) ||
            (physicalExamination.diastole >= 90 && physicalExamination.diastole <= 99)
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Hypertension");
        decision.setStage("Grade 1");
        decision.setPatientAdvice("Initiate lifestyle modifications and consider pharmacological treatment based on risk factors.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Grade 1 Hypertension Classification");
end

// Rule 4: Isolated Systolic Hypertension (Medium Priority)
rule "Isolated Systolic Hypertension Classification"
    salience 75
    when
        $patient: PatientData(
            consultation.consultationType != "follow_up",  // Don't classify for follow-up visits
            physicalExamination.systole >= 140 &&
            physicalExamination.diastole < 90
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Isolated Systolic Hypertension");
        decision.setStage("Based on systolic reading");
        decision.setPatientAdvice("Common in elderly patients. Requires pharmacological treatment and lifestyle modifications.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Isolated Systolic Hypertension Classification");
end

// Rule 5: Isolated Diastolic Hypertension (Medium Priority)
rule "Isolated Diastolic Hypertension Classification"
    salience 75
    when
        $patient: PatientData(
            consultation.consultationType != "follow_up",  // Don't classify for follow-up visits
            physicalExamination.systole < 140 &&
            physicalExamination.diastole >= 90
        )
        not ClinicalDecision(diagnosis == "Severe Hypertension")  // Don't fire if higher stages exist
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2")
        not ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Isolated Diastolic Hypertension");
        decision.setStage("Based on diastolic reading");
        decision.setPatientAdvice("More common in younger patients. Requires pharmacological treatment and lifestyle modifications.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Isolated Diastolic Hypertension Classification");
end

// Follow-up rule: uncontrolled hypertension compared to previous visit
rule "Hypertension Follow-up - BP still above target"
    salience 85  // Higher than initial classification rules
    when
        $patient: PatientData(
            consultation.consultationType == "follow_up",
            (previousSystole != null || previousDiastole != null),
            (physicalExamination.systole >= 140 || physicalExamination.diastole >= 90)
        )
    then
        ClinicalDecision decision = new ClinicalDecision();
        
        // Classify the current hypertension grade
        String grade = "Grade 1"; // default
        if (physicalExamination.systole >= 180 || physicalExamination.diastole >= 110) {
            grade = "Grade 3";
            decision.setDiagnosis("Severe Hypertension - uncontrolled on follow-up");
            decision.setPatientAdvice("EMERGENCY: Hypertensive urgency/emergency on follow-up. Immediate medical attention required. Step up therapy urgently.");
            decision.setNeedsReferral(true);
            decision.setReferralReason("Grade 3 Hypertension - uncontrolled on follow-up");
        } else if ((physicalExamination.systole >= 160 && physicalExamination.systole < 180) || 
                   (physicalExamination.diastole >= 100 && physicalExamination.diastole < 110)) {
            grade = "Grade 2";
            decision.setDiagnosis("Hypertension Grade 2 - uncontrolled on follow-up");
            decision.setPatientAdvice("Blood pressure remains above target on follow-up. Requires dual or triple combination therapy. Urgent step-up needed.");
            decision.setNeedsReferral(true);
            decision.setReferralReason("Grade 2 Hypertension - uncontrolled on follow-up");
        } else {
            decision.setDiagnosis("Hypertension Grade 1 - uncontrolled on follow-up");
            decision.setPatientAdvice("Blood pressure remains above target on follow-up. Step up monotherapy or initiate dual therapy per algorithm.");
        }
        
        decision.setStage(grade + " - BP not at target after previous visit");
        
        // Add treatment recommendations based on grade
        if (grade == "Grade 3") {
            decision.addMedication("Labetalol IV - first line emergency");
            decision.addMedication("Nicardipine IV - alternative");
            decision.addMedication("Nitroprusside IV - for specific emergencies");
        } else if (grade == "Grade 2") {
            decision.addMedication("(ACEI OR ARB) + CCB  -- DUAL THERAPY");
            decision.addMedication("OR (ACEI OR ARB) + Diuretic  -- DUAL THERAPY");
            decision.addMedication("Single Pill Combination preferred");
        } else {
            decision.addMedication("Amlodipine 5-10 mg once daily  -- CCB");
            decision.addMedication("Hydrochlorothiazide 12.5-25 mg once daily  -- Thiazide diuretic");
            decision.addMedication("Lisinopril 2.5-40 mg once daily  -- ACE inhibitor");
            decision.addMedication("Losartan 25-50 mg once daily  -- ARB");
        }
        
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Hypertension Follow-up - BP still above target");
end

// Rule 6: High Normal BP (Low Priority)
rule "High Normal Blood Pressure Classification"
    salience 60
    when
        $patient: PatientData(
            (physicalExamination.systole >= 130 && physicalExamination.systole <= 139) ||
            (physicalExamination.diastole >= 85 && physicalExamination.diastole <= 89)
        )
        not ClinicalDecision()  // Don't fire if any hypertension diagnosis exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("High Normal Blood Pressure");
        decision.setStage("Pre-Hypertension");
        decision.setPatientAdvice("Lifestyle modifications recommended: smoking cessation, physical activity 150 min/week, DASH diet. Monitor BP regularly.");
        decision.addTest("Annual BP monitoring");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: High Normal Blood Pressure Classification");
end

// Rule 7: Normal Blood Pressure (Lowest Priority)
rule "Normal Blood Pressure Classification"
    salience 50
    when
        $patient: PatientData(
            physicalExamination.systole < 130 &&
            physicalExamination.diastole < 85
        )
        not ClinicalDecision()  // Don't fire if any diagnosis exists
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Normal Blood Pressure");
        decision.setStage("Normal");
        decision.setPatientAdvice("Maintain healthy lifestyle with regular exercise and balanced diet. Follow DASH diet recommendations.");
        decision.setConfidenceLevel("HIGH");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Normal Blood Pressure Classification");
end

// =============================================
// INITIAL TREATMENT RECOMMENDATIONS (Figure 9)
// Notes:
//  - Where we list multiple alternatives that are mutually exclusive, we use "OR" (choose one).
//  - Where the regimen indicates combination therapy, we use "AND" between agents to indicate they are given together.
//  - The HC/MHC threshold for starting dual therapy is explicitly implemented: >150/95 mmHg -> start dual therapy.
// =============================================

// Rule 8: Grade 1 Hypertension - Monotherapy (choose ONE of the following)
rule "Grade 1 Hypertension Initial Therapy"
    when
        $patient: PatientData(
            (physicalExamination.systole >= 140 && physicalExamination.systole <= 159) ||
            (physicalExamination.diastole >= 90 && physicalExamination.diastole <= 99)
        )
        $decision: ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 1") from $patient.getDecisions()
    then
        // Clarified: these are alternative MONOTHERAPY options. Use one (OR) depending on comorbidity/contraindication.
        $decision.addMedication("Amlodipine 5-10 mg once daily  -- CCB (Preferred).  (MONOTHERAPY option)");
        $decision.addMedication("Hydrochlorothiazide 12.5-25 mg once daily  -- Thiazide diuretic (MONOTHERAPY option)");
        $decision.addMedication("Lisinopril 2.5-40 mg once daily  -- ACE inhibitor (MONOTHERAPY option; use if no contraindication)");
        $decision.addMedication("Losartan 25-50 mg once daily  -- ARB (MONOTHERAPY option; if ACEI not tolerated)");

        // Tests to request
        $decision.addTest("ECG");
        $decision.addTest("Urine Albumin-Creatinine ratio");
        $decision.addTest("Serum electrolytes and creatinine");
        $decision.addTest("Lipid profile");
        $decision.addTest("Fasting blood glucose/HbA1c");

        // Add explicit patient advice clarifying OR use
        String currentAdvice = $decision.getPatientAdvice();
        String medAdvice = "Initial pharmacological therapy (MONOTHERAPY) — choose ONE of: Amlodipine OR Thiazide OR ACEI (Lisinopril) OR ARB (Losartan) depending on comorbidity/contraindication.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + medAdvice);
        } else {
            $decision.setPatientAdvice(medAdvice);
        }

        System.out.println("Applied rule: Grade 1 Hypertension Initial Therapy");
end

// New Rule: Primary care (HC/MHC) threshold — explicit dual therapy initiation at >150/95
rule "Primary Care Threshold - Start Dual Therapy if BP >150/95 at HC/MHC"
    salience 89
    when
        // This rule implements the HC/MHC logic from the guideline:
        // "BP: <150/95 mmHg - initial therapy (monotherapy). BP: >150/95 mmHg - Start Dual therapy. Recheck after 4 weeks."
        $patient: PatientData(
            physicalExamination.systole > 150 ||
            physicalExamination.diastole > 95
        )
        // ensure we don't override Grade 3 emergency classification
        not ClinicalDecision(diagnosis == "Severe Hypertension")
    then
        ClinicalDecision decision = new ClinicalDecision();
        decision.setDiagnosis("Hypertension");
        decision.setStage("Primary care - Indication for Dual Therapy (HC/MHC)");
        // Clear instruction about dual therapy initiation and recheck timing
        decision.setPatientAdvice("BP >150/95 mmHg at primary care level: initiate DUAL THERAPY now (see combinations). Recheck after 4 weeks and titrate as needed.");
        decision.setConfidenceLevel("HIGH");

        // Dual therapy choices (explicit AND between combination partners, OR between different combination choices)
        // Show clearly: (ACEI or ARB) + (CCB)  OR  (ACEI or ARB) + (Diuretic)
        decision.addMedication("(ACEI OR ARB) + CCB  (Example: Lisinopril OR Losartan  PLUS  Amlodipine)  -- DUAL THERAPY");
        decision.addMedication("(ACEI OR ARB) + Diuretic  (Example: Lisinopril OR Losartan  PLUS  Hydrochlorothiazide/Indapamide)  -- DUAL THERAPY");
        decision.addMedication("Single Pill Combination (SPC) preferred when available (reduces pill burden)");

        // Tests
        decision.addTest("ECG - urgent");
        decision.addTest("Serum electrolytes and creatinine - baseline and follow-up");
        decision.addTest("Urine ACR");

        // Mark that this originated from HC/MHC guidance (informational)
        decision.setReferralReason("Start dual therapy at primary care when BP >150/95 mmHg; recheck after 4 weeks");
        $patient.addDecision(decision);
        System.out.println("Applied rule: Primary Care Threshold - Start Dual Therapy >150/95");
end

// Rule 9: Grade 2 Hypertension - Dual Therapy (Grade 2 or higher severity)
rule "Grade 2 Hypertension Dual Therapy"
    salience 88
    when
        $patient: PatientData(
            physicalExamination.systole >= 160 ||
            physicalExamination.diastole >= 100
        )
        $decision: ClinicalDecision(diagnosis == "Hypertension", stage == "Grade 2") from $patient.getDecisions()
    then
        // Dual combination therapy as per guidelines
        // Clarified wording: combinations use AND between agents; alternatives are separated with OR.
        $decision.addMedication("(ACEI OR ARB) + CCB  -- DUAL THERAPY (ACEI/ARB AND CCB together)");
        $decision.addMedication("OR (ACEI OR ARB) + Diuretic  -- DUAL THERAPY (ACEI/ARB AND Diuretic together)");
        $decision.addMedication("Single Pill Combination preferred when available");

        $decision.addTest("ECG - urgent");
        $decision.addTest("Echocardiogram if available");
        $decision.addTest("Complete renal function tests");
        $decision.addTest("Fundoscopy if indicated");

        // Patient advice clarifying AND/OR structure
        String cur = $decision.getPatientAdvice();
        String dualAdvice = "For dual therapy give two agents together (AND). Example combos: (ACEI OR ARB) AND CCB  OR  (ACEI OR ARB) AND Diuretic. Avoid ACEI + ARB together.";
        if(cur != null && !cur.trim().isEmpty()) {
            $decision.setPatientAdvice(cur + " " + dualAdvice);
        } else {
            $decision.setPatientAdvice(dualAdvice);
        }

        System.out.println("Applied rule: Grade 2 Hypertension Dual Therapy");
end

// Rule 10: Grade 3 Hypertension - Emergency Treatment
rule "Grade 3 Hypertension Emergency Therapy"
    when
        $patient: PatientData(
            physicalExamination.systole >= 180 ||
            physicalExamination.diastole >= 110
        )
        $decision: ClinicalDecision(diagnosis == "Severe Hypertension") from $patient.getDecisions()
    then
        // Emergency treatment options
        $decision.addMedication("Labetalol IV - first line emergency");
        $decision.addMedication("Nicardipine IV - alternative");
        $decision.addMedication("Nitroprusside IV - for specific emergencies");

        $decision.addTest("ECG - immediate");
        $decision.addTest("Cardiac enzymes - STAT");
        $decision.addTest("Renal function tests - STAT");
        $decision.addTest("Fundoscopy - urgent");
        $decision.addTest("CXR if pulmonary edema suspected");

        System.out.println("Applied rule: Grade 3 Hypertension Emergency Therapy");
end

// =============================================
// COMORBIDITY-BASED TREATMENT RECOMMENDATIONS
// (no change except clarifying OR usage in messages)
// =============================================

// Rule 11: Hypertension with Diabetes
rule "Hypertension with Diabetes Comorbidity"
    when
        $patient: PatientData(medicalHistory.diabetes == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // Preferred in diabetes: CCB or Thiazide (these are alternatives => OR)
        $decision.addMedication("CCB (Amlodipine) preferred in diabetes (OR)");
        $decision.addMedication("OR Thiazide diuretic (Hydrochlorothiazide/Indapamide)");
        $decision.addMedication("Target BP: 130/80 mmHg or lower if tolerated");

        $decision.addTest("HbA1c - quarterly monitoring");
        $decision.addTest("Urine ACR - annual");
        $decision.addTest("Foot examination");

        String currentAdvice = $decision.getPatientAdvice();
        String diabetesAdvice = "Strict blood pressure and glucose control needed. Target BP <130/80 mmHg. Regular eye and foot examinations.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + diabetesAdvice);
        } else {
            $decision.setPatientAdvice(diabetesAdvice);
        }

        System.out.println("Applied rule: Hypertension with Diabetes Comorbidity");
end

// Rule 12: Hypertension with Chronic Kidney Disease
rule "Hypertension with CKD Comorbidity"
    when
        $patient: PatientData(medicalHistory.chronicKidneyDisease == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // ARB or ACEI preferred in CKD (choose ONE unless contraindicated) -> OR
        $decision.addMedication("ARB or ACEI preferred (monitor potassium)  -- choose ONE (OR), unless contraindicated");
        $decision.addMedication("Target BP: <140/90 to 130/80 if tolerated");

        $decision.addTest("Serum potassium regularly");
        $decision.addTest("eGFR monitoring");
        $decision.addTest("Urine ACR");

        String currentAdvice = $decision.getPatientAdvice();
        String ckdAdvice = "ACEI/ARB preferred for renal protection. Monitor potassium levels regularly. Fluid and salt restriction may be needed.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + ckdAdvice);
        } else {
            $decision.setPatientAdvice(ckdAdvice);
        }

        System.out.println("Applied rule: Hypertension with CKD Comorbidity");
end

// Rule 13: Hypertension with CAD
rule "Hypertension with CAD Comorbidity"
    when
        $patient: PatientData(medicalHistory.cad == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // Beta-blockers indicated for CAD
        $decision.addMedication("Consider beta-blockers for CAD indication");
        $decision.addMedication("Target BP: 130/80 mmHg or lower if tolerated");

        $decision.addTest("Cardiac enzymes if symptomatic");
        $decision.addTest("Stress ECG if indicated");

        String currentAdvice = $decision.getPatientAdvice();
        String cadAdvice = "Beta-blockers recommended for coronary artery disease. Regular cardiac follow-up needed.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + cadAdvice);
        } else {
            $decision.setPatientAdvice(cadAdvice);
        }

        System.out.println("Applied rule: Hypertension with CAD Comorbidity");
end

// =============================================
// CONTRAINDICATIONS AND SAFETY RULES
// =============================================

// Rule 14: ACEI/ARB Contraindication - Hyperkalemia
rule "ACEI ARB Contraindication Hyperkalemia"
    when
        $patient: PatientData(medicalHistory.hyperkalemia == true)
        $decision: ClinicalDecision() from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String hyperkalemiaAdvice = "ACEI/ARB contraindicated due to hyperkalemia. Consider CCB or thiazide instead (OR).";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + hyperkalemiaAdvice);
        } else {
            $decision.setPatientAdvice(hyperkalemiaAdvice);
        }
        System.out.println("Applied rule: ACEI/ARB Contraindication - Hyperkalemia");
end

// Rule 15: Pregnancy and Hypertension
rule "Hypertension in Pregnancy"
    when
        $patient: PatientData(demographics.gender == "Female", medicalHistory.pregnant == true)
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        // First-line in pregnancy: Labetalol and Methyldopa (these are preferred options; can be used accordingly)
        $decision.addMedication("Labetalol - first line");
        $decision.addMedication("Methyldopa - first line");
        $decision.addMedication("Nifedipine ER - alternative");
        $decision.addMedication("Avoid ACEI/ARB - contraindicated in pregnancy");

        String currentAdvice = $decision.getPatientAdvice();
        String pregnancyAdvice = "OBSTETRICAL EMERGENCY: Urgent obstetric review needed. Target BP <140/90 mmHg. Labetalol or Methyldopa recommended.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + pregnancyAdvice);
        } else {
            $decision.setPatientAdvice(pregnancyAdvice);
        }

        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Hypertension in pregnancy - requires obstetric management");

        System.out.println("Applied rule: Hypertension in Pregnancy");
end

// =============================================
// HYPERTENSIVE EMERGENCY RULES
// =============================================

// Rule 16: Hypertensive Emergency Detection
rule "Hypertensive Emergency Detection"
    when
        $patient: PatientData(
            physicalExamination.systole >= 180 ||
            physicalExamination.diastole >= 120
        )
        $decision: ClinicalDecision(diagnosis == "Severe Hypertension") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String emergencyAdvice = "HYPERTENSIVE EMERGENCY: Immediate transfer to emergency department. Lower BP by 25% within first hour.";
        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + emergencyAdvice);
        } else {
            $decision.setPatientAdvice(emergencyAdvice);
        }

        $decision.setNeedsReferral(true);
        $decision.setReferralReason("Hypertensive emergency - requires hospital admission");

        $decision.addTest("ECG - immediate");
        $decision.addTest("Cardiac enzymes");
        $decision.addTest("Renal function tests");
        $decision.addTest("Fundoscopy");

        System.out.println("Applied rule: Hypertensive Emergency Detection");
end

// Rule 17: Lifestyle Recommendations for All Hypertension Patients
rule "Lifestyle Modifications All Hypertension"
    when
        $patient: PatientData()
        $decision: ClinicalDecision(diagnosis == "Hypertension") from $patient.getDecisions()
    then
        String currentAdvice = $decision.getPatientAdvice();
        String lifestyleAdvice = "Lifestyle modifications: Smoking cessation, DASH diet, 150 min/week moderate activity, weight management, salt restriction.";

        if(currentAdvice != null && !currentAdvice.trim().isEmpty()) {
            $decision.setPatientAdvice(currentAdvice + " " + lifestyleAdvice);
        } else {
            $decision.setPatientAdvice(lifestyleAdvice);
        }

        System.out.println("Applied rule: Lifestyle Modifications All Hypertension");
end
